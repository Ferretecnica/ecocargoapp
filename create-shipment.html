<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecocargo - Crear Nuevo Envío</title>
    <!-- Favicon (Logo en la pestaña) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%236ee7b7'><path stroke-linecap='round' stroke-linejoin='round' d='M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125V6.375c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v.001c0 .621.504 1.125 1.125 1.125z' /></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #111827; /* gray-900 */
            color: #f3f4f6; /* gray-100 */
        }
        .spinner { border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .card { background-color: #1f2937; border: 1px solid #374151; }
        .leaflet-tile { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
    </style>
</head>
<body class="bg-gray-900">

<script>
    const userData = sessionStorage.getItem('ecocargoUser');
    if (!userData) {
        window.location.href = 'index.html';
    }
    const user = JSON.parse(userData);
</script>

<div id="app-wrapper" class="relative min-h-screen">
    <header class="bg-gray-800/80 backdrop-blur-lg sticky top-0 z-30 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="dashboard.html" class="flex items-center space-x-4 text-white hover:text-emerald-400 transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                    <span>Volver al Panel</span>
                </a>
                <button id="logoutButton" class="bg-red-600 text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-red-700 transition-colors">
                    Cerrar Sesión
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 md:grid-cols-12 md:gap-8">
            <div class="md:col-span-5 lg:col-span-5 order-2 md:order-1 mt-6 md:mt-0">
                <div class="card p-6 rounded-xl shadow-lg">
                    <div id="progressBar" class="mb-8">
                        <!-- Progress bar will be generated by JS -->
                    </div>
                    <form id="shipmentForm">
                        <!-- Form steps will be injected here by JS -->
                    </form>
                    <div id="navigation" class="mt-8 flex justify-between">
                        <!-- Navigation buttons will be injected here by JS -->
                    </div>
                </div>
            </div>
            <div class="md:col-span-7 lg:col-span-7 order-1 md:order-2">
                <div class="card p-2 rounded-xl shadow-lg sticky top-[88px]">
                    <div class="relative mb-2">
                         <input type="text" id="addressSearch" placeholder="Buscar dirección y presionar Enter..." class="w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                         <svg class="w-5 h-5 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                    </div>
                    <div id="mapStatus" class="text-center text-sm bg-blue-900/50 text-blue-300 p-2 rounded-md mb-2"></div>
                    <div id="map" class="h-96 md:h-[calc(100vh-180px)] rounded-lg z-10 bg-gray-800"></div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 hidden">
        <div class="card rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <div id="notificationIcon"></div>
            <h3 id="notificationTitle" class="text-lg font-medium mt-4 text-white"></h3>
            <p id="notificationMessage" class="text-sm text-gray-300 mt-2"></p>
            <button id="notificationCloseBtn" class="mt-6 bg-emerald-600 text-white px-4 py-2 rounded-md w-full hover:bg-emerald-700">Entendido</button>
        </div>
    </div>
</div>

<script>
// --- CONFIG & STATE ---
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwsliiNP8YG3bx_31S0Lb60XA1Q_rGVmuH6gA0_HQ0CZUg3card7ZVxozXzem9W_w3q/exec';
const WHATSAPP_NUMBER = '50584016969';
let currentStep = 1;
const formState = {
    sender: { name: '', phone: '', coords: null },
    receiver: { name: '', phone: '', coords: null },
    package: { type: 'Documentos', notes: '' },
    cost: 0, distance: 0, orderId: ''
};
const stepsConfig = [
    { title: 'Remitente', fields: ['senderName', 'senderPhone'], mapInstruction: 'Fija el punto de <strong>origen</strong> en el mapa.' },
    { title: 'Destinatario', fields: ['receiverName', 'receiverPhone'], mapInstruction: 'Ahora, fija el punto de <strong>destino</strong>.' },
    { title: 'Paquete', fields: ['packageType', 'packageNotes'], mapInstruction: 'Revisa los detalles del paquete.' },
    { title: 'Confirmar', fields: [], mapInstruction: 'Ruta calculada. Confirma para finalizar.' }
];

// --- DYNAMIC FORM & UI GENERATION ---
function renderForm() {
    const formContainer = document.getElementById('shipmentForm');
    formContainer.innerHTML = `
        <!-- Paso 1: Remitente -->
        <div class="form-step" data-step="1">
            <h3 class="text-lg font-semibold mb-4 text-emerald-400">Información del Remitente</h3>
            <div>
                <label for="senderName" class="block text-sm font-medium text-gray-300">Nombre</label>
                <input type="text" id="senderName" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:border-emerald-500 focus:ring-emerald-500" placeholder="Nombre completo">
            </div>
            <div class="mt-4">
                <label for="senderPhone" class="block text-sm font-medium text-gray-300">Teléfono</label>
                <input type="tel" id="senderPhone" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:border-emerald-500 focus:ring-emerald-500" placeholder="Ej: 88887777">
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-300">Coordenadas Origen</label>
                <input type="text" id="senderCoords" class="mt-1 block w-full bg-gray-800 border-gray-600 rounded-md" readonly placeholder="Fijar en el mapa">
            </div>
        </div>
        <!-- Paso 2: Destinatario -->
        <div class="form-step hidden" data-step="2">
            <h3 class="text-lg font-semibold mb-4 text-emerald-400">Información del Destinatario</h3>
            <div>
                <label for="receiverName" class="block text-sm font-medium text-gray-300">Nombre</label>
                <input type="text" id="receiverName" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:border-emerald-500 focus:ring-emerald-500" placeholder="Nombre completo">
            </div>
            <div class="mt-4">
                <label for="receiverPhone" class="block text-sm font-medium text-gray-300">Teléfono</label>
                <input type="tel" id="receiverPhone" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:border-emerald-500 focus:ring-emerald-500" placeholder="Ej: 88887777">
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-300">Coordenadas Destino</label>
                <input type="text" id="receiverCoords" class="mt-1 block w-full bg-gray-800 border-gray-600 rounded-md" readonly placeholder="Fijar en el mapa">
            </div>
        </div>
        <!-- Paso 3: Paquete -->
        <div class="form-step hidden" data-step="3">
            <h3 class="text-lg font-semibold mb-4 text-emerald-400">Detalles del Paquete</h3>
            <div>
                <label for="packageType" class="block text-sm font-medium text-gray-300">Tipo de Paquete</label>
                <select id="packageType" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:border-emerald-500 focus:ring-emerald-500">
                    <option>Documentos</option><option>Caja Pequeña</option><option>Caja Mediana</option><option>Caja Grande</option><option>Otro</option>
                </select>
            </div>
            <div class="mt-4">
                <label for="packageNotes" class="block text-sm font-medium text-gray-300">Notas Adicionales</label>
                <textarea id="packageNotes" rows="3" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:border-emerald-500 focus:ring-emerald-500" placeholder="Ej: Paquete frágil, entregar en recepción..."></textarea>
            </div>
        </div>
        <!-- Paso 4: Confirmación -->
        <div class="form-step hidden" data-step="4">
            <h3 class="text-lg font-semibold mb-4 text-emerald-400">Resumen y Confirmación</h3>
            <div id="summary" class="space-y-3 text-sm p-4 bg-gray-800 rounded-lg border border-gray-700"></div>
            <p class="mt-4 text-xs text-gray-400">Al confirmar, se guardará el envío y se abrirá WhatsApp para compartir los detalles.</p>
        </div>
    `;
    document.getElementById('navigation').innerHTML = `
        <button type="button" id="prevBtn" class="bg-gray-600 text-white px-4 py-2 rounded-md font-medium hover:bg-gray-500 transition-colors hidden">Atrás</button>
        <button type="button" id="nextBtn" class="bg-emerald-600 text-white px-4 py-2 rounded-md font-medium hover:bg-emerald-700 transition-colors ml-auto">Siguiente</button>
        <button type="button" id="confirmBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-medium hover:bg-blue-700 transition-colors hidden w-full">
            <span id="confirmBtnText">Confirmar y Guardar</span>
            <div id="confirmSpinner" class="spinner w-5 h-5 border-2 border-white hidden mx-auto"></div>
        </button>
    `;
    document.getElementById('progressBar').innerHTML = `
        <div class="flex items-center">
        ${stepsConfig.map((step, index) => `
            <div class="step-item flex-1 text-center" data-step="${index + 1}">
                <div class="step-circle relative mx-auto w-8 h-8 rounded-full flex items-center justify-center font-bold transition-all duration-300">
                    ${index + 1}
                </div>
                <p class="mt-2 text-xs transition-all duration-300">${step.title}</p>
            </div>
            ${index < stepsConfig.length - 1 ? '<div class="progress-line flex-1 h-0.5 transition-all duration-300"></div>' : ''}
        `).join('')}
        </div>
    `;
}

function updateUI() {
    document.querySelectorAll('.form-step').forEach(step => step.classList.add('hidden'));
    document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.remove('hidden');

    document.querySelectorAll('#progressBar .step-item').forEach((item, index) => {
        const circle = item.querySelector('.step-circle');
        const text = item.querySelector('p');
        const line = document.querySelectorAll('.progress-line')[index - 1];

        if (index + 1 < currentStep) {
            circle.className = 'step-circle relative mx-auto w-8 h-8 rounded-full flex items-center justify-center font-bold transition-all duration-300 bg-emerald-600 text-white';
            text.className = 'mt-2 text-xs transition-all duration-300 text-gray-200';
            if(line) line.className = 'progress-line flex-1 h-0.5 transition-all duration-300 bg-emerald-600';
        } else if (index + 1 === currentStep) {
            circle.className = 'step-circle relative mx-auto w-8 h-8 rounded-full flex items-center justify-center font-bold transition-all duration-300 bg-blue-600 text-white scale-110';
            text.className = 'mt-2 text-xs transition-all duration-300 text-white font-semibold';
             if(line) line.className = 'progress-line flex-1 h-0.5 transition-all duration-300 bg-gray-600';
        } else {
            circle.className = 'step-circle relative mx-auto w-8 h-8 rounded-full flex items-center justify-center font-bold transition-all duration-300 bg-gray-700 text-gray-400';
            text.className = 'mt-2 text-xs transition-all duration-300 text-gray-500';
            if(document.querySelectorAll('.progress-line')[index]) document.querySelectorAll('.progress-line')[index].className = 'progress-line flex-1 h-0.5 transition-all duration-300 bg-gray-600';
        }
    });

    document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);
    document.getElementById('nextBtn').classList.toggle('hidden', currentStep === stepsConfig.length);
    document.getElementById('confirmBtn').classList.toggle('hidden', currentStep !== stepsConfig.length);

    const mapStatus = document.getElementById('mapStatus');
    mapStatus.innerHTML = stepsConfig[currentStep - 1].mapInstruction;
    mapStatus.classList.toggle('hidden', currentStep > 2 && currentStep < 4);
}

// --- MAP LOGIC ---
const map = L.map('map').setView([12.1364, -86.2514], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let originMarker = null, destinationMarker = null, routeLayer = null;
const originIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
const destIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });

function updateMarkerPosition(marker, latlng) {
    const coordsString = `${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`;
    if (marker === originMarker) {
        formState.sender.coords = latlng;
        document.getElementById('senderCoords').value = coordsString;
    } else {
        formState.receiver.coords = latlng;
        document.getElementById('receiverCoords').value = coordsString;
    }
}

map.on('click', (e) => {
    if (currentStep === 1) {
        if (!originMarker) {
            originMarker = L.marker(e.latlng, { draggable: true, icon: originIcon }).addTo(map);
            originMarker.on('dragend', (event) => updateMarkerPosition(event.target, event.target.getLatLng()));
        } else {
            originMarker.setLatLng(e.latlng);
        }
        updateMarkerPosition(originMarker, e.latlng);
    } else if (currentStep === 2) {
        if (!destinationMarker) {
            destinationMarker = L.marker(e.latlng, { draggable: true, icon: destIcon }).addTo(map);
            destinationMarker.on('dragend', (event) => updateMarkerPosition(event.target, event.target.getLatLng()));
        } else {
            destinationMarker.setLatLng(e.latlng);
        }
        updateMarkerPosition(destinationMarker, e.latlng);
    }
});

// --- FORM LOGIC ---
function validateStep(step) {
    const inputs = document.querySelectorAll(`.form-step[data-step="${step}"] input[required]`);
    let isValid = true;
    inputs.forEach(input => {
        input.classList.remove('border-red-500');
        if (!input.value.trim()) {
            input.classList.add('border-red-500');
            isValid = false;
        }
    });

    if (step === 1 && !formState.sender.coords) {
        showNotification('error', 'Mapa Requerido', 'Por favor, fija el punto de origen en el mapa.');
        isValid = false;
    }
    if (step === 2 && !formState.receiver.coords) {
        showNotification('error', 'Mapa Requerido', 'Por favor, fija el punto de destino en el mapa.');
        isValid = false;
    }
    return isValid;
}

function saveStepData(step) {
    if (step === 1) {
        formState.sender.name = document.getElementById('senderName').value;
        formState.sender.phone = document.getElementById('senderPhone').value;
    } else if (step === 2) {
        formState.receiver.name = document.getElementById('receiverName').value;
        formState.receiver.phone = document.getElementById('receiverPhone').value;
    } else if (step === 3) {
        formState.package.type = document.getElementById('packageType').value;
        formState.package.notes = document.getElementById('packageNotes').value;
    }
}

async function handleNextStep() {
    if (!validateStep(currentStep)) return;
    saveStepData(currentStep);
    if (currentStep < stepsConfig.length) {
        currentStep++;
        if (currentStep === stepsConfig.length) await generateSummary();
        updateUI();
    }
}

function handlePrevStep() {
    if (currentStep > 1) {
        currentStep--;
        if (routeLayer) map.removeLayer(routeLayer);
        updateUI();
    }
}

async function generateSummary() {
    const summaryDiv = document.getElementById('summary');
    summaryDiv.innerHTML = `<div class="flex justify-center items-center p-4"><div class="spinner w-6 h-6 border-4 border-emerald-500"></div><p class="ml-4">Calculando ruta y costo...</p></div>`;
    
    const { lat: lat1, lng: lng1 } = formState.sender.coords;
    const { lat: lat2, lng: lng2 } = formState.receiver.coords;
    const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?overview=full&geometries=geojson`;

    try {
        const response = await fetch(osrmUrl);
        const data = await response.json();
        if (data.code !== 'Ok') throw new Error('No se pudo encontrar una ruta.');

        const route = data.routes[0];
        formState.distance = (route.distance / 1000).toFixed(2);
        formState.cost = Math.max(50, formState.distance * 30).toFixed(2);
        formState.orderId = `ECO-${Date.now().toString().slice(-6)}`;

        if(routeLayer) map.removeLayer(routeLayer);
        routeLayer = L.geoJSON(route.geometry, { style: { color: '#3b82f6', weight: 6, opacity: 0.8 } }).addTo(map);
        map.fitBounds(routeLayer.getBounds().pad(0.1));

        summaryDiv.innerHTML = `
            <p class="flex justify-between"><span>ID de Orden:</span> <strong>${formState.orderId}</strong></p>
            <p class="flex justify-between"><span>De:</span> <strong>${formState.sender.name}</strong></p>
            <p class="flex justify-between"><span>Para:</span> <strong>${formState.receiver.name}</strong></p>
            <p class="flex justify-between"><span>Paquete:</span> <strong>${formState.package.type}</strong></p>
            <hr class="my-2 border-gray-600">
            <p class="flex justify-between"><span>Distancia:</span> <strong>${formState.distance} km</strong></p>
            <p class="flex justify-between text-lg font-bold text-emerald-400"><span>Costo Estimado:</span> <span>C$ ${formState.cost}</span></p>
        `;
    } catch (error) {
        summaryDiv.innerHTML = `<p class="text-red-400">Error al calcular la ruta: ${error.message}</p>`;
        document.getElementById('nextBtn').classList.remove('hidden');
        document.getElementById('confirmBtn').classList.add('hidden');
    }
}

async function handleConfirm() {
    const btn = document.getElementById('confirmBtn');
    const btnText = document.getElementById('confirmBtnText');
    const spinner = document.getElementById('confirmSpinner');
    btn.disabled = true;
    btnText.classList.add('hidden');
    spinner.classList.remove('hidden');

    const payload = {
        action: 'saveShipment', ...formState,
        senderCoords: `${formState.sender.coords.lat},${formState.sender.coords.lng}`,
        receiverCoords: `${formState.receiver.coords.lat},${formState.receiver.coords.lng}`,
        userId: user.id
    };

    try {
        // --- CÓDIGO REAL ACTIVADO ---
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Importante para Google Apps Script si no se maneja CORS
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });
        
        // Nota: Con 'no-cors', no podemos leer la respuesta, asumimos éxito si no hay error de red.
        // La lógica de abajo se ejecutará inmediatamente.
        // Si necesitas leer la respuesta, debes configurar CORS en tu script de Google.

        showNotification('success', '¡Envío Registrado!', 'Se abrirá WhatsApp para que compartas los detalles.');
        const senderLink = `https://www.google.com/maps?q=${payload.senderCoords}`;
        const receiverLink = `https://www.google.com/maps?q=${payload.receiverCoords}`;
        const message = `*Nuevo envío Ecocargo (ID: ${payload.orderId})*\n\n*De:* ${payload.sender.name}\n*Para:* ${payload.receiver.name}\n*Costo:* C$ ${payload.cost}\n\n*Origen:* ${senderLink}\n*Destino:* ${receiverLink}`;
        
        setTimeout(() => {
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');
            window.location.href = 'dashboard.html';
        }, 2000);

    } catch (error) {
        showNotification('error', 'Error', `No se pudo guardar el envío: ${error.message}`);
        btn.disabled = false;
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
    }
}

// --- NOTIFICATIONS & UTILS ---
function showNotification(type, title, message) {
    const modal = document.getElementById('notificationModal');
    const iconDiv = document.getElementById('notificationIcon');
    iconDiv.innerHTML = type === 'success' ?
        `<svg class="w-12 h-12 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>` :
        `<svg class="w-12 h-12 text-red-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
    document.getElementById('notificationTitle').textContent = title;
    document.getElementById('notificationMessage').textContent = message;
    modal.classList.remove('hidden');
}

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    renderForm();
    updateUI();

    document.getElementById('navigation').addEventListener('click', (e) => {
        if (e.target.id === 'nextBtn') handleNextStep();
        if (e.target.id === 'prevBtn') handlePrevStep();
        if (e.target.id === 'confirmBtn') handleConfirm();
    });

    document.getElementById('logoutButton').addEventListener('click', () => {
        sessionStorage.removeItem('ecocargoUser');
        window.location.href = 'index.html';
    });
    document.getElementById('notificationCloseBtn').addEventListener('click', () => {
        document.getElementById('notificationModal').classList.add('hidden');
    });
    document.getElementById('addressSearch').addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            const query = e.target.value;
            if (!query) return;
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.length > 0) map.setView([data[0].lat, data[0].lon], 15);
                else showNotification('error', 'No encontrado', 'No se encontraron resultados.');
            } catch (error) { showNotification('error', 'Error de Búsqueda', 'No se pudo conectar al servicio.'); }
        }
    });

    setTimeout(() => map.invalidateSize(), 100);
});
</script>

</body>
</html>
